WITH ARTIST_SALES AS (
    SELECT 
        ARTISTS.ARTISTID AS ARTIST_ID, 
        ARTISTS.NAME AS ARTIST_NAME,
        SUM(INVOICE_ITEMS.UNITPRICE * INVOICE_ITEMS.QUANTITY) AS TOTAL_SALES
    FROM 
        INVOICE_ITEMS
    JOIN 
        TRACKS ON TRACKS.TRACKID = INVOICE_ITEMS.TRACKID
    JOIN 
        ALBUMS ON ALBUMS.ALBUMID = TRACKS.ALBUMID
    JOIN 
        ARTISTS ON ARTISTS.ARTISTID = ALBUMS.ARTISTID
    GROUP BY 
        ARTISTS.ARTISTID, ARTISTS.NAME
),
BEST_SELLING_ARTIST AS (
    SELECT 
        ARTIST_ID, 
        ARTIST_NAME
    FROM 
        ARTIST_SALES
    ORDER BY 
        TOTAL_SALES DESC,
        ARTIST_NAME ASC
    LIMIT 1
),
LEAST_SELLING_ARTIST AS (
    SELECT 
        ARTIST_ID, 
        ARTIST_NAME
    FROM 
        ARTIST_SALES
    ORDER BY 
        TOTAL_SALES ASC,
        ARTIST_NAME ASC
    LIMIT 1
),
CUSTOMER_SPENDING AS (
    SELECT
        CUSTOMERS.FIRSTNAME,
        ARTISTS.NAME,
        SUM(INVOICE_ITEMS.UNITPRICE * INVOICE_ITEMS.QUANTITY) AS AMOUNT_SPENT
    FROM
        INVOICES
    JOIN
        CUSTOMERS ON CUSTOMERS.CUSTOMERID = INVOICES.CUSTOMERID
    JOIN
        INVOICE_ITEMS ON INVOICE_ITEMS.INVOICEID = INVOICES.INVOICEID
    JOIN
        TRACKS ON TRACKS.TRACKID = INVOICE_ITEMS.TRACKID
    JOIN
        ALBUMS ON ALBUMS.ALBUMID = TRACKS.ALBUMID
    JOIN
        ARTISTS ON ARTISTS.ARTISTID = ALBUMS.ARTISTID
    GROUP BY
        CUSTOMERS.FIRSTNAME, ARTISTS.NAME
),
AVERAGE_SPENDING AS (
    SELECT 
        NAME,
        AVG(AMOUNT_SPENT) AS AVERAGE_SPENT
    FROM 
        CUSTOMER_SPENDING
    WHERE 
        NAME IN (SELECT ARTIST_NAME FROM BEST_SELLING_ARTIST UNION SELECT ARTIST_NAME FROM LEAST_SELLING_ARTIST)
    GROUP BY 
        NAME
)
SELECT 
    ABS(
        (SELECT AVERAGE_SPENT FROM AVERAGE_SPENDING WHERE NAME = (SELECT ARTIST_NAME FROM BEST_SELLING_ARTIST))
        -
        (SELECT AVERAGE_SPENT FROM AVERAGE_SPENDING WHERE NAME = (SELECT ARTIST_NAME FROM LEAST_SELLING_ARTIST))
    ) AS DIFFERENCE;