/* Some example questions and corresponding SQL queries are provided based: */
/* Answer the following : I want to know the preferences of customers who purchased the Google Navy Speckled Tee in December 2020. What other product was purchased with the highest total quantity alongside this item?\nCan you tell me what other product are most frequently bought together with the Google Navy Speckled Tee by customers in December 2020? */
/* SQL query: */
WITH
  Params AS (
    SELECT 'Google Navy Speckled Tee' AS selected_product
  ),
  PurchaseEvents AS (
    SELECT
      user_pseudo_id,
      items
    FROM
      `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
    WHERE
      _TABLE_SUFFIX BETWEEN '20201201' AND '20201231'
      AND event_name = 'purchase'
  ),
  ProductABuyers AS (
    SELECT DISTINCT
      user_pseudo_id
    FROM
      Params,
      PurchaseEvents,
      UNNEST(items) AS items
    WHERE
      items.item_name = selected_product
  )
SELECT
  items.item_name AS item_name,
  SUM(items.quantity) AS item_quantity
FROM
  Params,
  PurchaseEvents,
  UNNEST(items) AS items
WHERE
  user_pseudo_id IN (SELECT user_pseudo_id FROM ProductABuyers)
  AND items.item_name != selected_product
GROUP BY 1
ORDER BY item_quantity DESC
LIMIT 1;

/* Answer the following : How many US patent applications about IoT applications were filed each month from 2008 to 2022? */
/* SQL query: */
WITH
  Patent_Matches AS (
    SELECT
      PARSE_DATE('%Y%m%d', SAFE_CAST(ANY_VALUE(patentsdb.filing_date) AS STRING)) AS Patent_Filing_Date,
      patentsdb.application_number AS Patent_Application_Number,
      ANY_VALUE(abstract_info.text) AS Patent_Title,
      ANY_VALUE(abstract_info.language) AS Patent_Title_Language
    FROM
      `patents-public-data.patents.publications` AS patentsdb,
      UNNEST(abstract_localized) AS abstract_info
    WHERE
      LOWER(abstract_info.text) LIKE '%internet of things%'
      AND patentsdb.country_code = 'US'
    GROUP BY
      Patent_Application_Number
  ),

  Date_Series_Table AS (
    SELECT
      day,
      0 AS Number_of_Patents
    FROM
      UNNEST(GENERATE_DATE_ARRAY(
        DATE '2008-01-01', 
        DATE '2022-12-31'
      )) AS day
  )

SELECT
  SAFE_CAST(FORMAT_DATE('%Y-%m', Date_Series_Table.day) AS STRING) AS Patent_Date_YearMonth,
  COUNT(Patent_Matches.Patent_Application_Number) AS Number_of_Patent_Applications
FROM
  Date_Series_Table
  LEFT JOIN Patent_Matches
    ON Date_Series_Table.day = Patent_Matches.Patent_Filing_Date
GROUP BY
  Patent_Date_YearMonth
ORDER BY
  Patent_Date_YearMonth;

/* Answer the following : How does average reputation and badge count vary among Stack Overflow users based on their tenure, measured in years? */
/* SQL query: */
SELECT User_Tenure,
       COUNT(1) AS Num_Users,
       ROUND(AVG(reputation)) AS Avg_Reputation,
       ROUND(AVG(num_badges)) AS Avg_Num_Badges
FROM (
  SELECT users.id AS user,
         ROUND(TIMESTAMP_DIFF(CURRENT_TIMESTAMP(), ANY_VALUE(users.creation_date), DAY)/365) AS user_tenure,
         ANY_VALUE(users.reputation) AS reputation,
         SUM(IF(badges.user_id IS NULL, 0, 1)) AS num_badges
  FROM `bigquery-public-data.stackoverflow.users` users
  LEFT JOIN `bigquery-public-data.stackoverflow.badges` badges
  ON users.id = badges.user_id
  GROUP BY user
)
GROUP BY User_Tenure
ORDER BY User_Tenure